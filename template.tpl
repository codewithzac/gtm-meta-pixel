___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Meta Pixel",
  "description": "An unofficial Meta Pixel template for Google Tag Manager, with built-in support for GTM Ecommerce events. Icon by Icons8.",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "SOCIAL"
  ],
  "brand": {
    "id": "github.com_codewithzac",
    "displayName": "codewithzac",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "containerContexts": [
    "WEB"
  ],
  "securityGroups": []
}


___TEMPLATE_PARAMETERS___

[
  {
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "errorMessage": "You must provide a Pixel ID",
        "type": "NON_EMPTY"
      },
      {
        "args": [
          "^[0-9,]+$"
        ],
        "errorMessage": "Invalid Pixel ID format",
        "type": "REGEX"
      }
    ],
    "displayName": "Meta Pixel ID(s)",
    "simpleValueType": true,
    "name": "pixelId",
    "type": "TEXT",
    "valueHint": "e.g. 1234567890",
    "help": "Enter Meta Pixel IDs - if there are more than one, separate them with commas (no spaces)"
  },
  {
    "type": "CHECKBOX",
    "name": "gtmEcommerce",
    "checkboxText": "GTM Ecommerce dataLayer Integration",
    "simpleValueType": true,
    "help": "If you check this, then the Meta pixel will populate \u003cstrong\u003eObject Properties\u003c/strong\u003e automatically from \u003ca href\u003d\"https://developers.google.com/analytics/devguides/collection/ga4/ecommerce?client_type\u003dgtm\"\u003eGTM Ecommerce\u003c/a\u003e event data pushed into the dataLayer array for supported ecommerce events."
  },
  {
    "type": "RADIO",
    "name": "eventName",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "standardEventName",
            "macrosInSelect": false,
            "selectItems": [
              {
                "displayValue": "PageView",
                "value": "PageView"
              },
              {
                "displayValue": "AddPaymentInfo",
                "value": "AddPaymentInfo"
              },
              {
                "displayValue": "AddToCart",
                "value": "AddToCart"
              },
              {
                "displayValue": "AddToWishlist",
                "value": "AddToWishlist"
              },
              {
                "displayValue": "CompleteRegistration",
                "value": "CompleteRegistration"
              },
              {
                "displayValue": "Contact",
                "value": "Contact"
              },
              {
                "displayValue": "CustomizeProduct",
                "value": "CustomizeProduct"
              },
              {
                "displayValue": "Donate",
                "value": "Donate"
              },
              {
                "displayValue": "FindLocation",
                "value": "FindLocation"
              },
              {
                "displayValue": "InitiateCheckout",
                "value": "InitiateCheckout"
              },
              {
                "displayValue": "Lead",
                "value": "Lead"
              },
              {
                "displayValue": "Purchase",
                "value": "Purchase"
              },
              {
                "displayValue": "Schedule",
                "value": "Schedule"
              },
              {
                "displayValue": "Search",
                "value": "Search"
              },
              {
                "displayValue": "StartTrial",
                "value": "StartTrial"
              },
              {
                "displayValue": "SubmitApplication",
                "value": "SubmitApplication"
              },
              {
                "displayValue": "Subscribe",
                "value": "Subscribe"
              },
              {
                "displayValue": "ViewContent",
                "value": "ViewContent"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "PageView"
          }
        ]
      },
      {
        "value": "custom",
        "displayValue": "Custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "customEventName",
            "displayName": "",
            "simpleValueType": true
          }
        ]
      },
      {
        "value": "variable",
        "displayValue": "Variable",
        "subParams": [
          {
            "type": "SELECT",
            "name": "variableEventName",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true
          }
        ]
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "gtmEcommerce",
        "paramValue": true,
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "gtmEventName",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "gtmEcom",
        "displayValue": "Set automatically from dataLayer"
      }
    ],
    "simpleValueType": true,
    "help": "The GTM Ecommerce integration populates the \u003cstrong\u003eEvent Name\u003c/strong\u003e automatically depending on the event that was last pushed into dataLayer (\"view_item\" -\u003e \"ViewContent\", \"add_to_cart\" -\u003e \"AddToCart\", \"add_to_wishlist\" -\u003e \"AddToWishlist\", \"begin_checkout\" -\u003e \"InitiateCheckout\", \"add_payment_info\" -\u003e \"AddPaymentInfo\", \"purchase\" -\u003e \"Purchase\").",
    "enablingConditions": [
      {
        "paramName": "gtmEcommerce",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "simpleValueType": true,
    "name": "advancedMatching",
    "checkboxText": "Enable Advanced Matching",
    "type": "CHECKBOX"
  },
  {
    "type": "GROUP",
    "name": "dataProcessingOptionsGroup",
    "displayName": "Data Processing Options",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "dpoInfo",
        "displayName": "Data Processing Options force this Meta event to comply to regional regulations with regard to the processing and selling of user data. Read \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/overview/data-processing-options\"\u003ethis\u003c/a\u003e for more information about how to configure this section."
      },
      {
        "type": "CHECKBOX",
        "name": "dpoLDU",
        "checkboxText": "Limited Data Use (LDU)",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "dpoCountry",
        "displayName": "Country",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "dpoState",
        "displayName": "State",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "advancedMatching",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "displayName": "Customer Information Data Parameters",
    "name": "advancedMatchingGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "displayName": "",
        "name": "advancedMatchingList",
        "simpleTableColumns": [
          {
            "selectItems": [
              {
                "displayValue": "City",
                "value": "ct"
              },
              {
                "displayValue": "Country",
                "value": "cn"
              },
              {
                "displayValue": "Date of Birth",
                "value": "db"
              },
              {
                "displayValue": "Email",
                "value": "em"
              },
              {
                "displayValue": "External ID",
                "value": "external_id"
              },
              {
                "displayValue": "First Name",
                "value": "fn"
              },
              {
                "displayValue": "Gender",
                "value": "ge"
              },
              {
                "displayValue": "Last Name",
                "value": "ln"
              },
              {
                "displayValue": "Phone",
                "value": "ph"
              },
              {
                "displayValue": "State",
                "value": "st"
              },
              {
                "displayValue": "Zip Code",
                "value": "zp"
              }
            ],
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add parameter",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "displayName": "Object Properties",
    "name": "objectPropertiesGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "gtmEcommerceObject",
        "displayName": "\u003cstrong\u003eWarning!\u003c/strong\u003e Object properties are populated automatically based on the most recent \u003cstrong\u003eecommerce\u003c/strong\u003e object pushed into dataLayer for supported events. If you add properties here that are already set by the integration (content_type, contents, num_items, value, currency), then the properties you add here will override those set automatically by the integration!",
        "enablingConditions": [
          {
            "paramName": "gtmEcommerce",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "objectPropertiesFromVariable",
        "displayName": "Load Properties From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can use a variable that returns a JavaScript object with the properties you want to use. This object will be merged with any additional properties you add via the table below. Any conflicts will be resolved in favor of the properties you add to the table."
      },
      {
        "name": "objectPropertyList",
        "simpleTableColumns": [
          {
            "valueValidators": [],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "More Settings",
    "name": "moreSettingsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "Meta collects some metadata (e.g. structured data) and user interactions (e.g. clicks) automatically. Check this box to disable this automatic configuration of the pixel.",
        "simpleValueType": true,
        "name": "disableAutoConfig",
        "checkboxText": "Disable Automatic Configuration",
        "type": "CHECKBOX"
      },
      {
        "type": "CHECKBOX",
        "name": "disablePushState",
        "checkboxText": "Disable History Event Tracking",
        "simpleValueType": true,
        "help": "The Meta Pixel tracks history events (pushState and replaceState) automatically as PageViews. Check this box to prevent the pixel from tracking such events automatically."
      },
      {
        "type": "TEXT",
        "name": "eventId",
        "displayName": "Event ID",
        "simpleValueType": true,
        "help": "Set the Event ID parameter in case you are tracking the same event server-side as well. The Event ID can be used to deduplicate the same event if sent from multiple sources. See more \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/deduplicate-pixel-and-server-events/\"\u003ehere\u003c/a\u003e."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const createQueue = require('createQueue');
const callInWindow = require('callInWindow');
const aliasInWindow = require('aliasInWindow');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const makeTableMap = require('makeTableMap');
const makeNumber = require('makeNumber');
const getType = require('getType');
const copyFromDataLayer = require('copyFromDataLayer');
const math = require('Math');
const log = require('logToConsole');

const initIds = copyFromWindow('_fbq_gtm_ids') || [];
const pixelIds = data.pixelId;
const standardEventNames = ['AddPaymentInfo', 'AddToCart', 'AddToWishlist', 'CompleteRegistration', 'Contact', 'CustomizeProduct', 'Donate', 'FindLocation', 'InitiateCheckout', 'Lead', 'Purchase', 'Schedule', 'Search', 'StartTrial', 'SubmitApplication', 'Subscribe', 'ViewContent', 'PageView'];
const ecommerce = copyFromDataLayer('ecommerce', 1);
const event = copyFromDataLayer('event', 1);

// Helper methods
const fail = msg => {
  log(msg);
  data.gtmOnFailure();
};

const mergeObj = (obj, obj2) => {
  for (let key in obj2) {
    if (obj2.hasOwnProperty(key)) {
      obj[key] = obj2[key];
    }
  }
  return obj;
};

const parseEcomObj = prod => {
  return {
    id: prod.item_id,
    item_price: prod.price,
    quantity: prod.quantity || 1
  };
};

// Initialize GTM Ecommerce integration
let eventName, ecomObjectProps;
if (data.gtmEcommerce) {
  if (!ecommerce) return fail('Meta Pixel: No valid "ecommerce" object found in dataLayer event');
  if (event === 'view_item') { eventName = 'ViewContent'; }
  else if (event === 'add_to_cart') { eventName = 'AddToCart'; }
  else if (event === 'add_to_wishlist') { eventName = 'AddToWishlist'; }
  else if (event === 'begin_checkout') { eventName = 'InitiateCheckout'; }
  else if (event === 'add_payment_info') { eventName = 'AddPaymentInfo'; }
  else if (event === 'purchase') { eventName = 'Purchase'; }
  else return fail('Meta Pixel: To use the GTM Ecommerce integration, the event must be one of "view_item", "add_to_cart", "add_to_wishlist", "begin_checkout", "add_payment_info" or "purchase".');

  if (!ecommerce.items || getType(ecommerce.items) !== 'array') return fail('Meta Pixel: Most recently pushed "ecommerce" object did not have a valid "items" array.');
  ecomObjectProps = {
    content_type: 'product',
    contents: ecommerce.items.map(parseEcomObj),
    value: ecommerce.value || ecommerce.items.reduce((acc, cur) => {
      const curVal = math.round(makeNumber(cur.price || 0) * (cur.quantity || 1) * 100) / 100;
      return acc + curVal;
    }, 0.0),
    currency: ecommerce.currency || 'USD'
  };
  if (['InitiateCheckout', 'Purchase'].indexOf(eventName) > -1) ecomObjectProps.num_items = ecommerce.items.reduce((acc, cur) => {
    return acc + makeNumber(cur.quantity || 1);
  }, 0);
}

// Build the fbq() command arguments
const cidParams = data.advancedMatchingList && data.advancedMatchingList.length ? makeTableMap(data.advancedMatchingList, 'name', 'value') : {};
const objectProps = data.objectPropertyList && data.objectPropertyList.length ? makeTableMap(data.objectPropertyList, 'name', 'value') : {};
const objectPropsFromVar = getType(data.objectPropertiesFromVariable) === 'object' ? data.objectPropertiesFromVariable : {};
const mergedObjectProps = mergeObj(objectPropsFromVar, objectProps);
const finalObjectProps = mergeObj(ecomObjectProps || {}, mergedObjectProps);
eventName = eventName || (data.eventName === 'custom' ? data.customEventName : (data.eventName === 'variable' ? data.variableEventName : data.standardEventName));

const command = standardEventNames.indexOf(eventName) === -1 ? 'trackSingleCustom' : 'trackSingle';

// Utility function to use either fbq.queue[]
// (if the FB SDK hasn't loaded yet), or fbq.callMethod()
// if the SDK has loaded.
const getFbq = () => {
  // Return the existing 'fbq' global method if available
  let fbq = copyFromWindow('fbq');
  if (fbq) {
    return fbq;
  }

  // Initialize the 'fbq' global method to either use
  // fbq.callMethod or fbq.queue)
  setInWindow('fbq', function() {    
    const callMethod = copyFromWindow('fbq.callMethod.apply');
    if (callMethod) {           
      callInWindow('fbq.callMethod.apply', null, arguments); 
    } else {       
      callInWindow('fbq.queue.push', arguments);
    }
  });
  aliasInWindow('_fbq', 'fbq');

  // Create the fbq.queue
  createQueue('fbq.queue');

  // Return the global 'fbq' method, created above
  return copyFromWindow('fbq');
};

// Get reference to the global method
const fbq = getFbq();

 // Set Data Processing Options
if (data.dpoLDU) {
  fbq('dataProcessingOptions', ['LDU'], makeNumber(data.dpoCountry), makeNumber(data.dpoState));
}

// Handle multiple, comma-separated pixel IDs,
// and initialize each ID if not done already.
pixelIds.split(',').forEach(pixelId => {
  if (initIds.indexOf(pixelId) === -1) {

    // If the user has chosen to disable automatic configuration
    if (data.disableAutoConfig) {
      fbq('set', 'autoConfig', false, pixelId);
    }

    // If the user has chosen to disable pushState and replaceState tracking
    if (data.disablePushState) {
      setInWindow('fbq.disablePushState', true);
    }

    // Initialize pixel and store in global array
    fbq('init', pixelId, cidParams);
    initIds.push(pixelId);
    setInWindow('_fbq_gtm_ids', initIds, true);

  }

  // Call the fbq() method with the parameters defined earlier
  if (data.eventId) {
    fbq(command, pixelId, eventName, finalObjectProps, {eventID: data.eventId});
  } else {
    fbq(command, pixelId, eventName, finalObjectProps);
  }
});

injectScript('https://connect.facebook.net/en_US/fbevents.js', data.gtmOnSuccess, data.gtmOnFailure, 'metaPixel');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq_gtm"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq_gtm_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.callMethod.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.disablePushState"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://connect.facebook.net/en_US/fbevents.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce"
              },
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Library is injected
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalledWith(scriptUrl, success, failure, 'metaPixel');
    assertApi('gtmOnSuccess').wasCalled();
- name: fbq does not exist - method created
  code: |-
    let fbq;

    mock('copyFromWindow', key => {
      if (key === 'fbq') return fbq;
    });

    mock('createQueue', key => {});

    mock('setInWindow', (key, val) => {
      if (key === 'fbq') fbq = val;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('aliasInWindow').wasCalledWith('_fbq', 'fbq');
    assertApi('setInWindow').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: fbq exists - method copied
  code: |-
    mock('setInWindow', key => {
      if (key === 'fbq') fail('setInWindow called with fbq even though variable exists');
    });

    mock('createQueue', key => {});

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: makeTableMap called
  code: |-
    mockData.advancedMatching = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingList, 'name', 'value');
    assertApi('makeTableMap').wasCalledWith(mockData.objectPropertyList, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();
- name: DPO LDU set
  code: |-
    mockData.dpoLDU = true;
    mockData.dpoCountry = '0';
    mockData.dpoState = '0';

    mock('copyFromWindow', key => {
      if (key === 'fbq') return function() {
        if (arguments[0] === 'dataProcessingOptions') {
          assertThat(arguments[1], 'LDU array value not set').isEqualTo(['LDU']);
          assertThat(arguments[2], 'LDU country not set').isEqualTo(0);
          assertThat(arguments[3], 'LDU state not set').isEqualTo(0);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: DPO LDU not set
  code: |-
    mock('copyFromWindow', key => {
      if (key === 'fbq') return function() {
        if (arguments[0] === 'dataProcessingOptions') {
          fail('dataProcessingOptions called even though DPO was not set');
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Pixel IDs set - do not initialize
  code: |-
    mock('copyFromWindow', key => {
      if (key === '_fbq_gtm_ids') return ['12345', '23456'];
      if (key === 'fbq') return function() {
        if (arguments[0] === 'init') fail('init called even though pixel IDs already initialized');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Send standard event
  code: "const eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index\
    \ = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.standardEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send custom event
  code: "mockData.eventName = 'custom';\n\nconst eventParams = {\n  prop1: 'val1',\n\
    \  prop2: 'val2'\n};\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if\
    \ (key === 'fbq') return function() {\n    if (arguments[0] === 'trackSingleCustom')\
    \ {\n      assertThat(arguments[1], 'trackSingleCustom called with incorrect pixel\
    \ ID').isEqualTo(mockData.pixelId.split(',')[index]);\n      assertThat(arguments[2],\
    \ 'trackSingleCustom called with incorrect event name').isEqualTo(mockData.customEventName);\n\
    \      assertThat(arguments[3], 'trackSingleCustom called with incorrect event\
    \ parameters').isEqualTo(eventParams);\n      index += 1;\n    }\n  };\n});\n\
    \     \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n//\
    \ Verify that the tag finished successfully.\nassertThat(index, 'trackSingleCustom\
    \ called incorrect number of times').isEqualTo(2);\nassertApi('gtmOnSuccess').wasCalled();"
- name: Send variable event with standard name
  code: "mockData.eventName = 'variable';\nmockData.variableEventName = 'PageView';\n\
    \nconst eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index =\
    \ 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.variableEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send variable event with custom name
  code: "mockData.eventName = 'variable';\nmockData.variableEventName = 'custom';\n\
    \nconst eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index =\
    \ 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingleCustom') {\n      assertThat(arguments[1],\
    \ 'trackSingleCustom called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingleCustom called with incorrect event\
    \ name').isEqualTo(mockData.variableEventName);\n      assertThat(arguments[3],\
    \ 'trackSingleCustom called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingleCustom called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send event parameters from a variable
  code: "mockData.objectPropertiesFromVariable = {\n  prop1: 'val1',\n  prop2: 'val2'\n\
    };\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.standardEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockData.objectPropertiesFromVariable);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: GTM Ecommerce integration fails with invalid object
  code: |-
    mockData.gtmEcommerce = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('logToConsole').wasCalledWith('Meta Pixel: No valid "ecommerce" object found in dataLayer event');
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: GTM Ecommerce integration fails with invalid event name
  code: |-
    mockData.gtmEcommerce = true;

    mock('copyFromDataLayer', (key, defaultValue) => {
      const mockDataLayer = {
        'event': 'purchase_complete',
        'ecommerce': mockEcom.gtm
      };
      return mockDataLayer[key] || defaultValue;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('logToConsole').wasCalledWith('Meta Pixel: To use the GTM Ecommerce integration, the event must be one of "view_item", "add_to_cart", "add_to_wishlist", "begin_checkout", "add_payment_info" or "purchase".');
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: GTM Ecommerce ViewContent works
  code: "mockData.gtmEcommerce = true;\nmockData.objectPropertyList = {};\n\nmock('copyFromDataLayer',\
    \ (key, defaultValue) => {\n  const mockDataLayer = {\n    'event': 'view_item',\n\
    \    'ecommerce': mockEcom.gtm\n  };\n  return mockDataLayer[key] || defaultValue;\n\
    });\n\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq')\
    \ return function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('ViewContent');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEcom.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: GTM Ecommerce AddToCart works
  code: "mockData.gtmEcommerce = true;\nmockData.objectPropertyList = {};\n\nmock('copyFromDataLayer',\
    \ (key, defaultValue) => {\n  const mockDataLayer = {\n    'event': 'add_to_cart',\n\
    \    'ecommerce': mockEcom.gtm\n  };\n  return mockDataLayer[key] || defaultValue;\n\
    });\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('AddToCart');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEcom.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: GTM Ecommerce InitiateCheckout works
  code: "mockData.gtmEcommerce = true;\nmockEcom.fb.num_items = 3;\nmockData.objectPropertyList\
    \ = {};\n\nmock('copyFromDataLayer', (key, defaultValue) => {\n  const mockDataLayer\
    \ = {\n    'event': 'begin_checkout',\n    'ecommerce': mockEcom.gtm\n  };\n \
    \ return mockDataLayer[key] || defaultValue;\n});\n\nlet index = 0;\nmock('copyFromWindow',\
    \ key => {\n  if (key === 'fbq') return function() {\n    if (arguments[0] ===\
    \ 'trackSingle') {\n      assertThat(arguments[1], 'trackSingle called with incorrect\
    \ pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n      assertThat(arguments[2],\
    \ 'trackSingle called with incorrect event name').isEqualTo('InitiateCheckout');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEcom.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: GTM Ecommerce Purchase works
  code: "mockData.gtmEcommerce = true;\nmockEcom.fb.num_items = 3;\nmockData.objectPropertyList\
    \ = {};\n\nmock('copyFromDataLayer', (key, defaultValue) => {\n  const mockDataLayer\
    \ = {\n    'event': 'purchase',\n    'ecommerce': mockEcom.gtm\n  };\n  return\
    \ mockDataLayer[key] || defaultValue;\n});\n\nlet index = 0;\nmock('copyFromWindow',\
    \ key => {\n  if (key === 'fbq') return function() {\n    if (arguments[0] ===\
    \ 'trackSingle') {\n      assertThat(arguments[1], 'trackSingle called with incorrect\
    \ pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n      assertThat(arguments[2],\
    \ 'trackSingle called with incorrect event name').isEqualTo('Purchase');\n   \
    \   assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEcom.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Object merge with variable and list works
  code: "mockData.objectPropertiesFromVariable = {\n  prop1: 'var1',\n  prop2: 'var2',\n\
    \  prop3: 'var3'\n};\n\nconst expected = {\n  prop1: 'val1',\n  prop2: 'val2',\n\
    \  prop3: 'var3'\n};\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if\
    \ (key === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle')\
    \ {\n      assertThat(arguments[1], 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('PageView');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(expected);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Object merge with variable, list and ecom works
  code: "mockData.gtmEcommerce = true;\nmockData.objectPropertiesFromVariable = {\n\
    \  content_type: 'product_group'\n};\nmockData.objectPropertyList = [{\n  name:\
    \ 'currency',\n  value: 'USD'\n}];\nmockEcom.fb.num_items = 3;\nmockEcom.fb.content_type\
    \ = 'product_group';\nmockEcom.fb.currency = 'USD';\n\nmock('copyFromDataLayer',\
    \ (key, defaultValue) => {\n  const mockDataLayer = {\n    'event': 'purchase',\n\
    \    'ecommerce': mockEcom.gtm\n  };\n  return mockDataLayer[key] || defaultValue;\n\
    });\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('Purchase');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEcom.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send event ID
  code: "mockData.eventId = 'eventId';\n\nmock('copyFromWindow', key => {\n  if (key\
    \ === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle') {\n\
    \      assertThat(arguments[4], 'eventID not included in hit').isEqualTo({eventID:\
    \ mockData.eventId});\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertApi('gtmOnSuccess').wasCalled();"
setup: "const mockData = {\n  pixelId: '12345,23456',\n  eventName: 'standard',\n\
  \  standardEventName: 'PageView',\n  customEventName: 'custom',\n  variableEventName:\
  \ 'standard',\n  advancedMatching: false,\n  advancedMatchingList: [{name: 'ct',\
  \ value: 'Melbourne'},{name: 'cn', value: 'Australia'},{name: 'external_id', value:\
  \ 'UserId'}],\n  objectPropertiesFromVariable: false,\n  objectPropertyList: [{name:\
  \ 'prop1', value: 'val1'},{name: 'prop2', value: 'val2'}],\n  disableAutoConfig:\
  \ false,\n  disablePushState: false,\n  gtmEcommerce: false,\n  eventId: ''\n};\n\
  \nconst mockEcom = {\n  gtm: {  \n    items: [{\n      item_id: 'i1',\n      item_name:\
  \ 'n1',\n      item_category: 'c1',\n      price: '1.00',\n      quantity: 1\n \
  \   },{\n      item_id: 'i2',\n      item_name: 'n2',\n      item_category: 'c2',\n\
  \      price: '2.00',\n      quantity: 2\n    }],\n    currency: 'AUD',\n    value:\
  \ 5.00\n  },\n  fb: {\n    content_type: 'product',\n    contents: [{\n      id:\
  \ 'i1',\n      item_price: '1.00',\n      quantity: 1\n    },{\n      id: 'i2',\n\
  \      item_price: '2.00',\n      quantity: 2\n    }],\n    currency: 'AUD',\n \
  \   value: 5.00\n  }\n};\n\nconst scriptUrl = 'https://connect.facebook.net/en_US/fbevents.js';\n\
  \n// Create injectScript mock\nlet success, failure;\nmock('injectScript', (url,\
  \ onsuccess, onfailure) => {\n  success = onsuccess;\n  failure = onfailure;\n \
  \ onsuccess();\n});\n\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
  \ () => {};\n});"


___NOTES___

Created on 13/07/2025, 01:39:49


